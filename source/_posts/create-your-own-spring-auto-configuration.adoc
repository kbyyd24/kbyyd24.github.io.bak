---
title: åˆ›å»ºè‡ªå·±çš„ Spring auto-configuration
tags:
  - spring
  - spring boot
  - auto configure
date: 2018-08-21 11:19:05
updated: 2018-08-21 11:19:05
---


`Spring Boot` ä¸ºæˆ‘ä»¬å¸¦æ¥äº†è‡ªåŠ¨é…ç½®çš„èˆ’é€‚ä½“éªŒï¼Œæå¤§çš„æé«˜äº†å¼€å‘æ•ˆç‡ã€‚å½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œè€Œè¿™äº›åº“æ²¡æœ‰å®ç° `Spring Boot Auto-Configururation` æ—¶ï¼Œæˆ‘ä»¬ä¸ºäº†é¿å…åœ¨ä¸åŒé¡¹ç›®ä¸­çš„é‡å¤é…ç½®ï¼Œå¯èƒ½éœ€è¦ä¸ºè¿™äº›åº“æä¾› `Auto-Configuration`ã€‚

`Spring Boot` ä¸ºæˆ‘ä»¬æä¾›äº†è‡ªå®šä¹‰ `auto-configuration` çš„æ–¹æ³•ï¼Œå¯ä»¥è®©æˆ‘ä»¬æ–¹ä¾¿çš„å®šä¹‰è‡ªå·±çš„ `bean` å¦‚ä½•æ³¨å…¥å®¹å™¨ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥å°†å’Œ `Spring` é›†æˆçš„ä»£ç é›†ä¸­èµ·æ¥ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡å¤é…ç½®ã€‚

== Spring å¦‚ä½•å®ç°è‡ªåŠ¨é…ç½®

https://www.jianshu.com/p/346cac67bfcc[ç®€ä¹¦ä¸Šçš„è¿™ç¯‡æ–‡ç« ] å¯¹ `Spring Boot` å¦‚ä½•å®ç°è‡ªåŠ¨é…ç½®åšäº†æ¯”è¾ƒè¯¦ç»†çš„ä»‹ç»ã€‚

ç®€å•æ¥è¯´ï¼Œ`Spring Boot` æä¾›äº† `spring-boot-autoconfigure` æ¥å®ç°è‡ªåŠ¨é…ç½®ï¼Œåˆ©ç”¨ `@Conditional` æ³¨è§£åˆ¤æ–­éœ€è¦é…ç½®çš„å†…å®¹ã€‚`Spring core` ä¸­çš„ `SpringFactoriesLoader` ç±»åˆ™ä¼šæ‰«æ `classpath` ä¸‹æ‰€æœ‰çš„ JAR åŒ…ä¸­ `META-INF/spring.factories` é‡Œçš„å†…å®¹ã€‚è¿™ä¸ªæ–‡ä»¶é‡ŒåŒ…å«äº†å¾ˆå¤š `Spring` é‡Œéœ€è¦çš„å†…å®¹ï¼Œæ¯”å¦‚ `ApplicationContextInitializer` ã€`ApplicationListener` ç­‰ç±»çš„å­ç±»ä¿¡æ¯ï¼Œ`Spring` å°†ä¼šæ ¹æ®å„è‡ªåœ¨ç”Ÿå‘½å‘¨æœŸä¸­éœ€è¦åŠ è½½çš„æ—¶é—´è¿›è¡ŒåŠ è½½ã€‚

[source,properties]
.spring boot autoconfigure ä¸­çš„ spring.factories éƒ¨åˆ†å†…å®¹
----
# Initializers
org.springframework.context.ApplicationContextInitializer=\
org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\
org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener

# Application Listeners
org.springframework.context.ApplicationListener=\
org.springframework.boot.autoconfigure.BackgroundPreinitializer

# Auto Configuration Import Listeners
org.springframework.boot.autoconfigure.AutoConfigurationImportListener=\
org.springframework.boot.autoconfigure.condition.ConditionEvaluationReportAutoConfigurationImportListener

# Auto Configuration Import Filters
org.springframework.boot.autoconfigure.AutoConfigurationImportFilter=\
org.springframework.boot.autoconfigure.condition.OnClassCondition

# Auto Configure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\
org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\
org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration

# Failure analyzers
org.springframework.boot.diagnostics.FailureAnalyzer=\
org.springframework.boot.autoconfigure.diagnostics.analyzer.NoSuchBeanDefinitionFailureAnalyzer,\
org.springframework.boot.autoconfigure.jdbc.DataSourceBeanCreationFailureAnalyzer,\
org.springframework.boot.autoconfigure.jdbc.HikariDriverConfigurationFailureAnalyzer,\
org.springframework.boot.autoconfigure.session.NonUniqueSessionRepositoryFailureAnalyzer

# Template availability providers
org.springframework.boot.autoconfigure.template.TemplateAvailabilityProvider=\
org.springframework.boot.autoconfigure.freemarker.FreeMarkerTemplateAvailabilityProvider,\\
org.springframework.boot.autoconfigure.thymeleaf.ThymeleafTemplateAvailabilityProvider,\
org.springframework.boot.autoconfigure.web.servlet.JspTemplateAvailabilityProvider
----

åœ¨ `Spring Boot autoconfigure` ä¸­ï¼Œæä¾›äº† `AutoConfigurationImportSelector` ç±»ç”¨æ¥è¯»å– `spring.factories` ä¸­çš„ `org.springframework.boot.autoconfigure.EnableAutoConfiguration` çš„å€¼ï¼Œç„¶å `Spring` ä¼šåŠ è½½è¿™é‡Œè¯»åˆ°çš„æ‰€æœ‰çš„ `Configuration`ã€‚è¿™äº›è¢«è¯»å–åˆ°çš„ `Configuration` ä¸€å®šè¦æ˜¯ `Auto-configuration class`ï¼Œåœ¨ `Spring` ä¸­ï¼Œè¢« `@Configuration` æ³¨è§£çš„ç±»å°±ç¬¦åˆè¿™ä¸ªæ¡ä»¶ã€‚

== å®ç°è‡ªå·±çš„ auto configuration

æ ¹æ®å‰é¢çš„ç†è§£ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°å¦‚ä½•æ¥å®ç°è‡ªå·±çš„ auto configurationã€‚

1. ç¼–å†™è‡ªå®šä¹‰çš„é…ç½®ç±»ï¼Œå¹¶åŠ ä¸Š `@Configuration` æ³¨è§£
2. åœ¨ `resources` ç›®å½•ä¸‹åˆ›å»º `META-INF/spring.factories`

åœ¨ `Spring` å®˜ç½‘ï¼Œä¹Ÿè¯¦ç»†çš„è®²è¿°äº†å¦‚ä½•å®ç°è‡ªå·±çš„è‡ªåŠ¨é…ç½®ï¼šhttps://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-developing-auto-configuration.html

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚`github` ä¸Šé¢æœ‰ä¸€ä¸ªé¡¹ç›®å«åš https://github.com/vorburger/MariaDB4j[MariaDB4j]ã€‚å®ƒå¯ä»¥ä¸ºæˆ‘ä»¬çš„ Java é¡¹ç›®æä¾›ä¸€ä¸ª `embedded mariaDB`ã€‚ç„¶è€Œåœ¨ä¸ `Spring Boot` é›†æˆçš„æ—¶å€™å‘ç°ï¼Œå¦‚æœè¦å°† `mariaDB4j` ä½œä¸ºä¸€ä¸ª `bean` æ³¨å…¥åˆ°æˆ‘ä»¬çš„ `Spring Context` é‡Œï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åœ¨ `mariaDB` å¯åŠ¨ä¹‹åï¼Œ`Spring` æ‰ä¼šå»åŠ è½½ `dataSource`ã€‚æˆ‘ä»¬ä¸å¾—ä¸é‡å†™ä¸€ä¸ª `dataSource` æ¥æ³¨å…¥ `Spring`ã€‚

[source, java]
----
@Bean
@DependsOn("mariaDB4j") #<1>
public DataSource dataSource(DataSourceProperties dataSourceProperties) {
    return DataSourceBuilder.create()
            .driverClassName(dataSourceProperties.getDriverClassName())
            .url(dataSourceProperties.getUrl())
            .username(dataSourceProperties.getUsername())
            .password(dataSourceProperties.getPassword())
            .build();
}
----
<1> `dataSource` éœ€è¦ç­‰å¾… `mariaDB4j` åŠ è½½å®Œæˆæ‰èƒ½è¢«åŠ è½½

æ˜¾ç„¶ï¼Œæˆ‘ä»¬ä¸æƒ³åœ¨æ¯æ¬¡ä½¿ç”¨çš„æ—¶å€™éƒ½è¦å†™ä¸€ä»½è¿™æ ·çš„ä»£ç ï¼Œå¦‚æœèƒ½å¤Ÿå•çº¯çš„æŠŠ `mariaDB4j` å¼•å…¥åˆ°æˆ‘ä»¬çš„ `classpath` ä¸­å°±èƒ½ä½¿ç”¨ï¼Œé‚£æ‰æ˜¯æˆ‘ä»¬æœŸæœ›çš„ç”¨æ³•ã€‚æ‰€ä»¥æˆ‘é€‰æ‹©äº†ä¸ºå®ƒæ·»åŠ  `auto-configuration` çš„æ–¹å¼ã€‚

=== åˆ›å»º MariaDB4jSpringConfiguration

å°† `MariaDB4j` æºç æ‹‰ä¸‹æ¥ä¹‹åï¼Œæ–°å»ºäº†ä¸€ä¸ªåä¸º `mariaDB4j-springboot` çš„ `sub module`ã€‚ç„¶ååŠ ä¸Šæˆ‘ä»¬éœ€è¦çš„ä¾èµ–ã€‚

[source,xml]
----
<dependencies>
    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>mariaDB4j</artifactId>
        <version>${project.version}</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-autoconfigure-processor</artifactId>
        <optional>true</optional>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
----

ç„¶åï¼Œæ·»åŠ æˆ‘ä»¬çš„ `Auto-configuration class`

[source,java]
@Configuration
public class MariaDB4jSpringConfiguration {
    @Bean
    public MariaDB4jSpringService mariaDB4j() {
        return new MariaDB4jSpringService();
    }
}

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•è¿™ä¸ªé…ç½®ç±»èƒ½å¤Ÿè¢«æˆåŠŸçš„åŠ è½½ã€‚è¿™é‡Œçš„æµ‹è¯•æˆ‘è¿˜æ²¡æœ‰ç†è§£åˆ°ï¼Œä»…ä»…æ˜¯æŒ‰ç…§å®˜ç½‘çš„ä¾‹å­æ¥å†™äº†ä¸€ä¸ªæµ‹è¯•ï¼š

[source,java]
----
public class MariaDB4JSpringConfigurationTest {

    private final ApplicationContextRunner contextRunner = new ApplicationContextRunner()
            .withConfiguration(AutoConfigurations.of(MariaDB4jSpringConfiguration.class));

    @Test
    public void shouldAutoConfigureEmbeddedMariaDB() {
        this.contextRunner.withUserConfiguration(MariaDB4jSpringConfiguration.class)
                .run(context -> {
                    assertThat(context).hasSingleBean(MariaDB4jSpringService.class);
                    assertThat(context.getBean(MariaDB4jSpringService.class))
                            .isSameAs(context.getBean(MariaDB4jSpringConfiguration.class).mariaDB4j());
                });
    }

}
----

è¿™é‡Œçš„ä¸ç†è§£åœ¨äºï¼Œåˆ›å»ºçš„è¿™ä¸ª `ApplicationContextRunner` ç±»ä¸èƒ½è‡ªåŠ¨çš„å»æ‰«æ `bean` è€Œè¦è®©æˆ‘ä»¬æ‰‹åŠ¨çš„å»åŠ è½½å®ƒã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±ä¸èƒ½é€šè¿‡è¿™ä¸ªæµ‹è¯•æ¥éªŒè¯è¿™ä¸ªç±»ä¼šè¢«è‡ªåŠ¨é…ç½®ã€‚

=== åˆ›å»º dataSource bean

åœ¨ `mariaDB4j` å¯åŠ¨å®Œæˆåï¼Œæˆ‘ä»¬å°±èƒ½åˆ›å»º `dataSource` äº†ã€‚å› ä¸º `Spring` åœ¨ `dataSource` åˆ›å»ºåä¼šå°è¯•è¿æ¥ï¼Œæ‰€ä»¥ä¸€å®šè¦ä¿è¯ `mariaDB4j` å…ˆåˆ›å»ºã€‚

[source,java]
----
@Bean
@DependsOn("mariaDB4j") #<1>
public DataSource dataSource(DataSourceProperties dataSourceProperties) {
    return DataSourceBuilder.create()
            .driverClassName(dataSourceProperties.getDriverClassName())
            .url(dataSourceProperties.getUrl())
            .username(dataSourceProperties.getUsername())
            .password(dataSourceProperties.getPassword())
            .build();
}
----
<1> é€šè¿‡ `bean` çš„åç§°æ¥åˆ¤æ–­éœ€è¦ä¾èµ–å“ªä¸ª `bean`

=== æ·»åŠ  spring.factories

æœ‰äº†è¿™äº›ï¼Œ`Spring` è¿˜ä¸èƒ½è‡ªåŠ¨é…ç½®æˆ‘ä»¬çš„é…ç½®ç±»ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ `src/main/resources/META-INF` ä¸‹æ·»åŠ  `spring.factories` æ–‡ä»¶ï¼Œè®© `Spring` æ‰«æè¿™ä¸ªæ–‡ä»¶åçŸ¥é“å“ªäº›ç±»å¯ä»¥è‡ªåŠ¨é…ç½®ã€‚

[source,properties]
----
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  ch.vorburger.mariadb4j.springboot.autoconfigure.MariaDB4jSpringConfiguration,\
  ch.vorburger.mariadb4j.springboot.autoconfigure.DataSourceAutoConfiguration
----

è¿™é‡Œæ·»åŠ çš„ç±»åä¸€å®šæ˜¯åŒ…å« `package` çš„å…¨åï¼Œå¦åˆ™ `Spring` æ‰¾ä¸åˆ°æŒ‡å®šçš„ç±»ã€‚

---

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†è‡ªåŠ¨é…ç½®çš„å·¥ä½œï¼Œæ‰“åŒ…å¥½åå°±èƒ½ä½¿ç”¨äº†ï¼š

[source,bash]
.æ‰“åŒ…
----
mvn clean install
----

ç„¶åæˆ‘ä»¬èƒ½å¤Ÿåœ¨æœ¬åœ° `maven` ä»“åº“çœ‹åˆ° `ch/vorburger/mariaDB4j` ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª `mariaDB4j-springboot`ï¼Œ æ¥ä¸‹æ¥å°±èƒ½ä½¿ç”¨äº†ã€‚

[source,gradle]
----
dependencies {
  testCompile("ch.vorburger.mariaDB4j:mariaDB4j-springboot:2.3.1-SNAPSHOT")
}
----

è¿™æ¬¡çš„å®è·µæäº†ä¸€ä¸ª `PR` åˆ° https://github.com/vorburger/MariaDB4j/pull/153/(mariaDB4j)ï¼Œä¹Ÿç®—æ˜¯é€šè¿‡å®è·µæ¥å­¦ä¹ äº†ã€‚

== æ€»ç»“

è¦å®ç°è‡ªå·±çš„ `auto-configuration` è¿˜ç®—ç®€å•ï¼Œåªéœ€è¦ä¸¤æ­¥ï¼š

1. æ·»åŠ è‡ªå·±çš„ `Configuration` ç±»
2. å°†è‡ªå·±æ·»åŠ çš„é…ç½®ç±»å†™åˆ° `META-INF/spring.factories` é‡Œ

ä½†æ˜¯ï¼Œè¿™èƒŒåçš„å®ç°å´æœ‰äº›å¤æ‚ï¼Œå€¼å¾—æ·±å…¥ç ”ç©¶ã€‚è¿™é‡Œä¼šæ¶‰åŠåˆ° `Spring` çš„å¤§é‡çŸ¥è¯†ï¼ŒåŒ…æ‹¬å„ç§åŒ…çš„ä¾èµ–ã€`spring.factories` çš„è¯»å–ã€`@Conditional` æ³¨è§£ç­‰ç­‰ï¼Œæ¯ä¸€ä¸ªéƒ½å¯ä»¥ç ”ç©¶ä¸€ä¸‹å†™ä¸€ç¯‡åšå®¢å‡ºæ¥ğŸ¶ğŸ¶ã€‚