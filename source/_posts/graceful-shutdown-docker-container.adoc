---
title: ä½ çš„ docker stopï¼Œå®ƒä¼˜é›…å—ï¼Ÿ
tags:
  - docker
  - linux
  - exec
  - trap
  - wait
description: å¦‚ä½•ä¼˜é›…çš„å…³é—­ Docker container
date: 2020-06-18 22:46:13
updated: 2020-06-18 22:46:13
---


æˆ‘ä»¬å¹³æ—¶åœ¨ä½¿ç”¨ `Docker` çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ `ctrl+c` æˆ–è€… `docker stop` çš„æ–¹å¼å…³é—­å®¹å™¨ã€‚
ä½†æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ° `ctrl+c` ä¸ç”Ÿæ•ˆï¼Œæˆ–è€… `docker stop` ä¹‹åè¦ç­‰å¾… 10s çš„æƒ…å†µï¼Œå°±åƒè¿™æ ·ï¼š

image::docker-stop-10s.png[]

ä¹Ÿè®¸ä½ ä¼šè§‰å¾— 10s æ˜¯ä¸€ä¸ªå¯ä»¥å¿å—çš„æ—¶é—´ï¼Œ
ä½†è¿™æ ·çš„é—®é¢˜çœŸçš„åªæœ‰ 10s è¿™ä¹ˆç®€å•å—ï¼Ÿ
ä¸ºä»€ä¹ˆæœ‰çš„æ—¶å€™ä¸èƒ½ç«‹å³å…³é—­å®¹å™¨å‘¢ï¼Ÿ

== docker stop æ€ä¹ˆå…³é—­å®¹å™¨

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‘½ä»¤åšäº†ä»€ä¹ˆã€‚

=== `ctrl+c` åˆ°åº•åšäº†ä»€ä¹ˆ 

æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ `ctrl+c` çš„åœºæ™¯ï¼Œæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨ `foreground` æ¨¡å¼è¿è¡Œå®¹å™¨çš„æ—¶å€™ã€‚
è¿™æ—¶æˆ‘ä»¬æŒ‰ä¸‹ `ctrl+c` å°±åƒåœ¨æ™®é€šçš„ `shell` ä¸­æŒ‰ä¸‹è¿™ä¸ªç»„åˆé”®ä¸€æ ·ï¼Œå‘é€ä¸€ä¸ª `SIGINT` ä¿¡å·ç»™å½“å‰çš„è¿›ç¨‹ï¼Œé€šçŸ¥å®ƒç»ˆæ­¢è¿è¡Œã€‚

=== docker stop åšäº†ä»€ä¹ˆ

`docker stop` å‘½ä»¤æ˜¯åœ¨å¯¹ `detached` æ¨¡å¼è¿è¡Œçš„å®¹å™¨å‘å‡ºåœæ­¢å‘½ä»¤æ—¶ä½¿ç”¨çš„ï¼Œä»å‘é€ä¿¡å·ä¸Šæ¥è®²ï¼Œå®ƒå°†å‘é€ `SIGTERM` ä¿¡å·ç»™å®¹å™¨ï¼Œé€šçŸ¥å…¶ç»“æŸè¿è¡Œã€‚

> `SIGINT` ä¸€èˆ¬ç”¨äºå…³é—­å‰å°è¿›ç¨‹ï¼Œ`SIGTERM` ä¼šè¦æ±‚è¿›ç¨‹è‡ªå·±æ­£å¸¸é€€å‡ºã€‚

å½“æˆ‘ä»¬åœ¨ `shell` ä¸­ç»™è¿›ç¨‹å‘é€ `SIGTERM` å’Œ `SIGINT` ä¿¡å·çš„æ—¶å€™ï¼Œè¿™äº›è¿›ç¨‹å¾€å¾€éƒ½èƒ½æ­£ç¡®çš„å¤„ç†ã€‚
ä½†æ˜¯åœ¨ `docker` ä¸­å´ä¸çµäº†ã€‚
è¿™æ˜¯å› ä¸ºåœ¨ `docker` ä¸­ï¼Œåªä¼šå°† `SIGTERM` ç­‰æ‰€æœ‰çš„ `signal` ä¿¡å·å‘é€ç»™ PID ä¸º 1 çš„è¿›ç¨‹ï¼Œå½“æˆ‘ä»¬ `docker` ä¸­è¿è¡Œçš„è¿›ç¨‹çš„è¿›ç¨‹å·ä¸æ˜¯ 1 æ—¶ï¼Œå°±ä¸ä¼šæ”¶åˆ°è¿™æ ·çš„ä¿¡å·ã€‚

> æ ¹æ®link:https://mp.weixin.qq.com/s/vaIBGHmdUT0bHP2O722AQQ[è¿™ç¯‡æ–‡ç« ]çš„è¯´æ³•ï¼Œåªæœ‰ `alpine` ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œä½†ä»æˆ‘æœåˆ°çš„èµ„æ–™å’Œå®éªŒæ¥çœ‹ï¼Œå¹¶ä¸æ˜¯è¿™æ ·ï¼Œè€Œæ˜¯æ‰€æœ‰çš„é•œåƒéƒ½ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚

=== ä¸ºä»€ä¹ˆæ˜¯ 10s

å…¶å®è¿™åªæ˜¯ `docker` çš„é»˜è®¤è®¾ç½®ï¼Œå¦‚æœä½ æ„¿æ„ï¼Œç­‰åå¹´éƒ½å¯ä»¥ã€‚
æ–‡æ¡£é“¾æ¥ï¼šlink:https://docs.docker.com/engine/reference/commandline/stop/[]

å¦‚æœè¾¾åˆ°ä¸Šé¢çš„æ—¶é—´é™åˆ¶ï¼Œ`docker` å°†ä¼šé€šè¿‡ç»™å†…æ ¸å‘é€ `SIGKILL` ä»è€Œå¼ºåˆ¶ç»“æŸå®¹å™¨ã€‚

=== éªŒè¯ä¸Šé¢çš„å›ç­”

ä¸ºäº†éªŒè¯ä¸Šé¢æŸ¥åˆ°çš„è¿™äº›ç»“æœï¼Œæˆ‘å†™äº†ä¸€ç‚¹ demoã€‚
åœ¨ demo çš„åœºæ™¯é‡Œï¼Œæˆ‘ä»¬ä¼šåœ¨ `ENTRYPOINT` é…ç½®è¿è¡Œä¸€ä¸ª `shell` è„šæœ¬ï¼Œåœ¨è„šæœ¬ä¸­åšä¸€äº›å‡†å¤‡å·¥ä½œåå¯åŠ¨è¿›ç¨‹ã€‚

[source,Dockerfile]
----
FROM openjdk:8-jre-alpine
COPY ./build/libs/app.jar /app/app.jar
COPY ./docker/entrypoint.sh /app/entrypoint.sh
WORKDIR /app
EXPOSE 8080
ENTRYPOINT ["./entrypoint.sh"]
----

[source,bash]
.entrypoint.sh
----
#!/bin/sh
echo 'Do something'
java -jar app.jar
----

> åé¢è¿˜ä¼šç”¨åˆ°è¿™ä¸ªä¾‹å­

æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿä¸€ä¸‹ `docker stop` ä¹‹åï¼Œ`shell` ç»™æˆ‘ä»¬çš„è¿”å›å€¼

image::docker-stop-10s-kill.png[title=æ³¨æ„çº¢è‰²æ–¹æ¡†]

æ ¹æ®è¿™å¼ å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°:

. `docker stop` å‘½ä»¤ç­‰å¾…äº† 10s æ‰ç»“æŸ
. ç»“æŸçš„ docker container è¿”å›äº† `137`ï¼Œè¡¨ç¤ºè¿›ç¨‹æ˜¯å› ä¸ºå†…æ ¸æ¥æ”¶åˆ°äº† `SIGKILL` è€Œç»“æŸçš„ï¼ˆ`zsh` ç»™ç¾åŒ–æˆäº† KILLï¼‰

=== Kill å¯¼è‡´çš„é—®é¢˜

ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº† `ctrl+c` ä¸ºä»€ä¹ˆä¸ç”Ÿæ•ˆå’Œ `docker stop` ç­‰å¾… 10s çš„åŸå› äº†ã€‚
æˆ‘ä»¬å†æ¥çœ‹çœ‹å¦ä¸€ä¸ªé—®é¢˜ï¼š
**å¼ºåˆ¶å…³é—­å®¹å™¨ï¼ŒçœŸçš„å°±æ²¡é—®é¢˜å—ï¼Ÿ**

æˆ–è®¸ä½ èƒ½æƒ³åˆ°ï¼Œå¾ˆå¤šè¿›ç¨‹åœ¨ç»“æŸé˜¶æ®µä¼šåšä¸€äº›æ¸…ç†å·¥ä½œï¼šæ¯”å¦‚åˆ é™¤ä¸´æ—¶ç›®å½•ã€æ‰§è¡Œ shutdown hook ç­‰ã€‚
ä½†æ˜¯å½“è¿›ç¨‹è¢«å¼ºåˆ¶å…³é—­æ—¶ï¼Œè¿™äº›ä»»åŠ¡å°±ä¸ä¼šè¢«æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯èƒ½å¾—åˆ°ä¸€äº›å¹¶ä¸æœŸæœ›çš„ç»“æœã€‚

ä»¥ `Eureka` ä¸ºä¾‹ã€‚
`Eureka client` åœ¨ç»“æŸè¿›ç¨‹æ—¶ï¼Œéœ€è¦å‘ `Eureka server` å‘é€ shutdown ä¿¡å·ï¼Œä»¥æ³¨é”€ `client`ã€‚
è¿™æœ¬æ¥æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸º `Eureka server` å³ä½¿æ²¡æœ‰æ”¶åˆ°è¿™æ ·çš„ä¿¡æ¯ï¼Œä¹Ÿä¼šå®šæœŸæ¸…ç† `client` ä¿¡æ¯ã€‚
ä½†æ˜¯ `Eureka server` è¿˜æœ‰ä¸€ä¸ª `self preservation` æ¨¡å¼ï¼Œä»¥é˜²æ­¢æ„å¤–çš„ç½‘ç»œäº‹ä»¶å¯¼è‡´å¤§é‡çš„ `client` ä¸‹çº¿ã€‚
è¿™å°±æœ‰å¯èƒ½å¯¼è‡´ `Eureka` é›†ç¾¤çš„æ³¨å†Œè¡¨ä¸­å‡ºç°å¤§é‡çš„ `client` ä¿¡æ¯ï¼Œä½†å®ƒä»¬å…¶å®å·²ç»å…³é—­äº†ã€‚

== å¦‚ä½•ä¼˜é›…çš„å…³é—­å®¹å™¨

é€šè¿‡å‰é¢çš„å†…å®¹ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†å®¹å™¨æ²¡æœ‰è¢«ä¼˜é›…å…³é—­çš„åŸå› å’Œå¯èƒ½å¯¼è‡´çš„é—®é¢˜ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•è§£å†³ã€‚

> å‰é¢æåˆ°çš„é‚£ç¯‡æ–‡ç« ä¸­æåˆ°å¯ä»¥ä½¿ç”¨ `tini` æ¥è§£å†³ï¼Œä½†æˆ‘æ²¡æœ‰æˆåŠŸè¿‡ã€‚`tini` çš„ç¡®åšåˆ°äº†ç«‹å³å…³é—­è¿›ç¨‹ï¼Œä½†æ˜¯è¿›ç¨‹å¹¶æ²¡æœ‰æ‰§è¡Œ shutdown hookã€‚

=== ä½¿ç›®æ ‡è¿›ç¨‹æˆä¸º PID 1

æ—¢ç„¶ `docker` åªä¼šå°† `sigal` å‘é€ç»™ PID 1 çš„è¿›ç¨‹ï¼Œé‚£å°±è®©æˆ‘ä»¬çš„è¿›ç¨‹æˆä¸º PID 1 çš„è¿›ç¨‹å°±å¥½äº†ã€‚

==== docker çš„ exec ä¸ shell æ¨¡å¼

`Dockerfile` çš„ `ENTRYPOINT` æœ‰ä¸¤ç§å†™æ³•ï¼Œå³ `exec` å’Œ `shell`ï¼š

[source,Dockerfile]
----
# exec form
ENTRYPOINT ["command", "param"]
# shell form
ENTRYPOINT command param
----

ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼š

- `exec` å½¢å¼çš„å‘½ä»¤ä¼šä½¿ç”¨ PID 1 çš„è¿›ç¨‹
- `shell` å½¢å¼çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œä¸º `/bin/sh -c <command>`ï¼Œä¸ä¼šæ‰§è¡Œåœ¨ PID 1 ä¸Šï¼Œä¹Ÿå°±ä¸ä¼šæ”¶åˆ° `signal`

æ‰€ä»¥ï¼Œæˆ‘ä»¬åº”è¯¥é€‰æ‹© `exec` æ¨¡å¼ï¼Œè®©æˆ‘ä»¬çš„ç¨‹åºæˆä¸º PID 1 è¿›ç¨‹ã€‚

[source,Dockerfile]
----
ENTRYPOINT ["java", "-jar", "app.jar"]
----

> æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹link:https://docs.docker.com/engine/reference/builder/#entrypoint[å®˜æ–¹æ–‡æ¡£]ã€‚

==== exec å‘½ä»¤

`exec` å½¢å¼çš„ `ENTRYPOINT` åªèƒ½è§£å†³ __æ— éœ€ä»»ä½•å‡†å¤‡å·¥ä½œå°±å¯åŠ¨è¿›ç¨‹__ çš„åœºæ™¯ï¼Œè€Œä¸èƒ½è§£å†³ä¸€äº›éœ€è¦å‡†å¤‡å·¥ä½œçš„å¤æ‚åœºæ™¯ã€‚

åœ¨è¿™æ ·çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬çš„ `ENTRYPOINT` å¾€å¾€éœ€è¦æ‰§è¡Œä¸€ä¸ª `shell` è„šæœ¬ï¼š

[source,Dockerfile]
----
ENTRYPOINT ["./entrypoint.sh"]
----

ç„¶ååœ¨è¿™ä¸ªè„šæœ¬ä¸­æ‰§è¡Œæˆ‘ä»¬çš„å‡†å¤‡å·¥ä½œï¼Œå®Œæˆåå†å¯åŠ¨çœŸæ­£çš„è¿›ç¨‹ã€‚
æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œåšå®Œå‡†å¤‡åï¼Œå¯åŠ¨ `java` è¿›ç¨‹ã€‚
è¿™æ—¶å€™ï¼Œæˆ‘ä»¬çš„ `java` è¿›ç¨‹å°±æ— æ³•æˆä¸º PID 1 è¿›ç¨‹ã€‚

image::docker-exec-ps-not-pid-1.png[]

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`java` è¿›ç¨‹çš„ PID æ˜¯ 7ï¼Œä¹Ÿå°±æ— æ³•ä¼˜é›…é€€å‡ºäº†ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `exec` å‘½ä»¤æ¥è§£å†³ã€‚è¿™ä¸ªå‘½ä»¤çš„ä½œç”¨å°±æ˜¯**ä½¿ç”¨æ–°çš„è¿›ç¨‹æ›¿ä»£åŸæœ‰çš„è¿›ç¨‹ï¼Œå¹¶ä¿æŒ PID ä¸å˜**ã€‚
è¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œ `java` å‘½ä»¤çš„æ—¶å€™ä½¿ç”¨å®ƒï¼Œä»è€Œæ›¿æ¢æ‰ PID 1 çš„ shell è„šæœ¬ï¼š

[source,bash]
.entrypoint.sh
----
#!/bin/sh
echo "Do something"
exec java -jar app.jar
----

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å®¹å™¨ä¸­çš„è¿›ç¨‹ï¼š

image::docker-exec-ps-pid-1.png[]

ä½¿ç”¨ `exec` å‘½ä»¤ä¹‹åï¼Œæˆ‘ä»¬æ— è®ºæ˜¯ä½¿ç”¨ `ctrl+c` è¿˜æ˜¯ `docker stop` éƒ½èƒ½è®©è¿›ç¨‹æ¥æ”¶åˆ°ä¿¡å·ï¼Œæ‰§è¡Œç›¸åº”çš„æ“ä½œåé€€å‡ºï¼š

image::docker-stop-success-by-exec.png[]

è¿™å¼ å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆå¤šä¿¡æ¯ï¼š

. `docker stop` å‘½ä»¤å¾ˆå¿«ç»“æŸï¼Œæ²¡æœ‰ç­‰å¾…åç§’
. å®¹å™¨é€€å‡ºæ”¶åˆ°çš„ä¿¡å·æ˜¯ `SIGTERM`ï¼Œä¸æ˜¯ `SIGKILL`
. `Spring` è¿›ç¨‹çš„æœ€åä¸€è¡Œæ—¥å¿—æ˜¯ shutdown hook çš„æ—¥å¿—

è¿™äº›ä¿¡æ¯è¡¨æ˜ï¼Œ`java` è¿›ç¨‹æ”¶åˆ°äº† `docker stop` å‘é€çš„ `SIGTERM` ä¿¡å·ï¼Œå¹¶ä¸”æ­£ç¡®çš„è§¦å‘äº†ç›¸å…³æ“ä½œï¼Œæœ€åé€€å‡ºç¨‹åºã€‚

=== ä½¿ç”¨ trap

`exec` å‘½ä»¤åœ¨è¿™æ ·çš„åœºæ™¯ä¸‹ç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œç¾çš„æ–¹æ¡ˆã€‚
ä½†å¦‚æœä½ è¿˜æƒ³æ¢ç´¢ä¸€ä¸‹å…¶ä»–æ–¹å¼ï¼Œæˆ–è€…ä½ çš„å®¹å™¨ä¸­éœ€è¦è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œé‚£æˆ‘ä»¬å¯ä»¥æ¥ç€æ¥çœ‹çœ‹ `trap` å‘½ä»¤ã€‚

`trap` æ˜¯ç”¨æ¥è®¾ç½®é™·é˜±ã€ç›‘å¬ `signal` çš„ `shell` å‘½ä»¤ï¼Œä¸€èˆ¬ç”¨æ¥å¤„ç†è„šæœ¬æ”¶åˆ°çš„ `signal`ï¼Œå®Œæˆä¸€äº›æ“ä½œã€‚

[source,bash]
----
trap [-lp] [[arg] sigspec ...]
----

> æœ¬æ–‡ä¸ä»‹ç» `lp` å‚æ•°çš„å«ä¹‰

- `arg` ä»£è¡¨æ¥æ”¶åˆ°æŸä¸ªä¿¡å·åè¦æ‰§è¡Œçš„æ“ä½œï¼Œæ˜¯ä¸€ä¸ª `shell` å‘½ä»¤
- `sigspec` è¡¨ç¤ºç›‘å¬çš„ä¿¡å·ï¼Œå¯ä»¥æ˜¯å¤šä¸ª

ä¸¾ä¸ªğŸŒ°ï¼š

[source,bash]
----
trap 'echo "Shutting Down"' TERM #<1>
----
<1> è¡¨ç¤ºåœ¨æ¥æ”¶åˆ° `SIGTERM` ä¿¡å·æ—¶è¾“å‡º "Shutting Down"

==== æ·»åŠ  trap

ç®€å•äº†è§£äº† `trap` å‘½ä»¤åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥æ”¹é€ ä¸€ä¸‹ `entrypoint.sh`ï¼š

[source,bash]
.entrypoint.sh
----
#!/bin/sh
echo 'Do something'

kill_jar() {
  echo 'Received TERM'
  kill "$(ps -ef | grep java | grep app | awk '{print $1}')" #<1>
}

trap 'kill_jar' TERM INT #<2>

java -jar app.jar
----
<1> æ‰¾åˆ°æ‰§è¡Œçš„è¿›ç¨‹ï¼Œä½¿ç”¨ `kill` å‘½ä»¤å‘å…¶å‘é€ `SIGTERM`
<2> åœ¨è„šæœ¬ä¸­ç›‘å¬ `SIGTERM` å’Œ `SIGINT` ä¿¡å·ï¼Œç„¶åæ‰§è¡Œ `kill_jar` å‡½æ•°

ä¸Šé¢çš„è„šæœ¬çœ‹èµ·æ¥å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†å®é™…ä¸Šä¸èƒ½ã€‚

è¿™æ˜¯å› ä¸ºåœ¨ `bash` ä¸­ï¼Œå³ä½¿ `trap` æ”¶åˆ°äº†ä¿¡å·ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ `bash` åœ¨ç­‰å¾…ä¸€ä¸ªå‘½ä»¤ç»“æŸçš„è¯ï¼Œ
é‚£ä¹ˆ `trap` å°±ä¼šç­‰åˆ°è¿™ä¸ªå‘½ä»¤ç»“æŸæ‰ä¼šè¢«æ‰§è¡Œã€‚

[quote,https://www.gnu.org/software/bash/manual/html_node/Signals.html#Signals]
____
If Bash is waiting for a command to complete and receives a signal for which a trap has been set, the trap will not be executed until the command completes.
____

åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œ`bash` å°±åœ¨ç­‰å¾… `java` è¿›ç¨‹ç»“æŸï¼Œæ‰èƒ½æ‰§è¡Œ `trap` ä¸­çš„å‘½ä»¤ã€‚
ä½†æ˜¯ `java` è¿›ç¨‹åˆéœ€è¦ `trap` æ¥å…³é—­æ‰èƒ½ç»“æŸï¼Œæ‰€ä»¥ç¨‹åºé™·å…¥äº†å¾ªç¯ä¾èµ–ï¼Œåªèƒ½ `docker stop` ç­‰å¾… 10sã€‚

==== åå°è¿è¡Œ java

æ—¢ç„¶å‰é¢çš„é—®é¢˜æ˜¯ `bash` åœ¨ç­‰å¾… `java` è¿›ç¨‹ç»“æŸï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®©å®ƒä¸ç­‰å¾…å°±å¥½äº†â€”â€”åå°æ‰§è¡Œ `java`ï¼š

[source,bash]
.entrypoint.sh
----
#!/bin/sh
echo 'Do something'

kill_jar() {
  echo 'Received TERM'
  kill "$(ps -ef | grep java | grep app | awk '{print $1}')"
  echo 'Process finished'
}

trap 'kill_jar' TERM INT

java -jar app.jar & #<1>

wait $! #<2>
----
<1> åå°æ‰§è¡Œ `java`
<2> ä½¿ç”¨ `wait` å‘½ä»¤ç­‰å¾… `java` è¿›ç¨‹ç»“æŸï¼Œé¿å… `entrypoint.sh` æ‰§è¡Œå®Œæˆåå®¹å™¨ç›´æ¥é€€å‡º

æ˜¯ä¸æ˜¯è§‰å¾—è¿™æ ·å°± OK äº†ï¼Ÿ
Naiveï¼Œä¸Šé¢çš„è¿™ä¸ªè„šæœ¬èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ç«‹å³ç»“æŸå®¹å™¨ï¼Œä½†å¹¶ä¸ä¼šç­‰å¾…è¿›ç¨‹è‡ªå·±æ­£å¸¸é€€å‡ºï¼š

image::docker-stop-without-shutdown.png[]

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`kill_jar` æ–¹æ³•ä¸­çš„ `echo` è¢«æˆåŠŸæ‰§è¡Œï¼Œä½†æ˜¯å´æ²¡æœ‰çœ‹åˆ° `Spring` çš„ shutdown hook æ—¥å¿—è¾“å‡ºã€‚
è¿™è¯´æ˜å®¹å™¨æ²¡æœ‰ç­‰å¾…ç¨‹åºæ­£å¸¸é€€å‡ºå°±è¢«å…³é—­äº†ã€‚

è¿™é‡Œå…¶å®æœ‰ä¸¤ä¸ªé—®é¢˜ã€‚

`kill` çš„é—®é¢˜::
ç¬¬ä¸€ä¸ªæ˜¯ `kill` å‘½ä»¤å¹¶ä¸ä¼šç­‰å¾…è¿›ç¨‹ç»“æŸï¼Œå®ƒåªè´Ÿè´£å‘è¿›ç¨‹å‘é€ `SIG` ä¿¡å·ã€‚
è‡³äºç¨‹åºå¦‚ä½•å¤„ç†ã€ä»€ä¹ˆæ—¶å€™å¤„ç†ï¼Œåˆ™ä¸å®ƒæ— ç“œã€‚

`wait` çš„é—®é¢˜::
ç¬¬äºŒä¸ªé—®é¢˜åˆ™æ˜¯ `wait` å‘½ä»¤ï¼Œåœ¨ä¸Šé¢ `bash` å¯¹ `trap` çš„è§£é‡Šåé¢ï¼Œè¿˜æœ‰ä¸€å¥è¯ï¼š

[quote,https://www.gnu.org/software/bash/manual/html_node/Signals.html#Signals]
____
When Bash is waiting for an asynchronous command via the wait builtin, the reception of a signal for which a trap has been set will cause the wait builtin to return immediately with an exit status greater than 128, immediately after which the trap is executed.
____

ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶ `bash` åœ¨ç­‰å¾… `wait` ç»“æŸï¼Œä½†æ˜¯ `wait` åˆè¢«ç‰¹æ®Šå¤„ç†äº†
â€”â€”`trap` æ”¶åˆ°ä»»ä½•å¤§äº 128 çš„ä¿¡å·éƒ½ä¼šè®© `wait` å‘½ä»¤ç»“æŸï¼Œä»¥æ‰§è¡Œ `trap` ä¸­çš„æ–¹æ³•ã€‚

ç»¼åˆä»¥ä¸Šä¸¤ç‚¹ï¼Œæˆ‘ä»¬ä¼šå‘ç° `trap` åœ¨æ‰§è¡Œ `kill_jar` æ—¶ï¼Œ`entrypoint.sh` ä¸­çš„ `wait` å·²ç»ç»“æŸï¼Œä¸å†ç­‰å¾… `java` è¿›ç¨‹ç»“æŸã€‚
`kill_jar` ä»…ä»…å‘é€äº† `SIGTERM` ä¿¡å·ï¼Œä¹Ÿä¸ä¼šç­‰å¾… `java` è¿›ç¨‹ç»“æŸã€‚

ç”±æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹è„šæœ¬è¿›è¡Œæ”¹è¿›ï¼š

[source,bash]
.entrypoint.sh
----
#!/bin/sh

echo 'Do something'

kill_jar() {
  echo 'Received TERM'
  kill "$(ps -ef | grep java | grep app | awk '{print $1}')"
  wait $! #<1>
  echo 'Process finished'
}

trap 'kill_jar' TERM INT

java -jar app.jar &

wait $!
----
<1> åœ¨ `kill` ååŠ äº†ä¸€è¡Œ `wait`ï¼Œå› ä¸º `kill` ä¼šè¿”å›è¿›ç¨‹å·ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨ `$!`ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬çš„ `kill_jar` å°±ä¼šç­‰åˆ° `java` è¿›ç¨‹å®Œå…¨é€€å‡ºåæ‰ä¼šç»“æŸï¼š

image::docker-stop-success-by-trap.png[]

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`Spring` çš„ shutdown hook åœ¨ "Process finished" ä¹‹å‰è¾“å‡ºï¼Œè¯æ˜æ–°åŠ çš„ `wait` å‘½ä»¤å‘æŒ¥äº†ä½œç”¨ã€‚

== æ€»ç»“

. `ctrl+c` ä¸ `docker stop` éƒ½åªä¼šå‘å®¹å™¨ä¸­ PID 1 è¿›ç¨‹å‘é€ä¿¡å·
. `docker stop` é»˜è®¤ç­‰å¾… 10s æ²¡æœ‰å…³é—­å®¹å™¨åï¼Œä¼šå‘å†…æ ¸å‘é€ `SIGKILL` ä»¥å¼ºåˆ¶å…³é—­å®¹å™¨
. è§£å†³æ–¹æ¡ˆï¼š
.. ç›´æ¥å¯åŠ¨è¿›ç¨‹æ—¶ï¼Œä½¿ç”¨ `ENTRYPOINT` çš„ `exec form`
.. å¯åŠ¨å•ä¸€è¿›ç¨‹ï¼Œå¹¶ä¸”éœ€è¦ä¸€ç‚¹å‡†å¤‡å·¥ä½œæ—¶ï¼Œä½¿ç”¨ `exec` å‘½ä»¤
.. å¯åŠ¨å¤šä¸ªè¿›ç¨‹æ—¶ï¼Œç»„åˆä½¿ç”¨ `trap`ã€`wait`ã€`kill` å‘½ä»¤


