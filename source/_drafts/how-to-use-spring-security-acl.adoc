---
title: å¦‚ä½•ä½¿ç”¨ Spring Security ACL
tags:
  - spring
  - spirng security
  - spring security acl
  - spring security acl demo
description: ä½¿ç”¨ Spring Security ACL çš„ä¾‹å­
---

åœ¨link:/2020/07/02/spring-security-acl-conception-and-component/[ä¸Šä¸€ç¯‡æ–‡ç« ]ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº† Spring Security ACL çš„åŸºæœ¬æ¦‚å¿µã€‚
ä½†æ˜¯å‡ ä¹æ²¡æœ‰æ¶‰åŠå®ç°ä¸ä½¿ç”¨çš„éƒ¨åˆ†ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±æ¥çœ‹ä¸€çœ‹å¦‚ä½•åœ¨ä½¿ç”¨äº† Spring çš„é¡¹ç›®ä¸­ä½¿ç”¨ Spring Securityã€‚

== å¯¼å…¥ Jar åŒ…

Spring Security ACL çš„ GAV æ˜¯ `org.springframework.security:spring-security-acl:<version>`ï¼Œ
è¢«åŠ å…¥åˆ°äº† link:https://docs.spring.io/platform/docs/1.0.1.RELEASE/reference/htmlsingle/#appendix-dependency-versions[Spring IO Platform bom] ä¸­ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ Spring çš„ä¾èµ–ç®¡ç†æ’ä»¶æ¥ç®¡ç†ç‰ˆæœ¬å·ã€‚

ä½†æ˜¯ Spring æ²¡æœ‰æä¾›ç›¸åº”çš„ boot starterï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦è‡ªå·±è¿›è¡Œé…ç½®ã€‚
æ¯•ç«Ÿ ACL ä¸­æä¾›çš„é»˜è®¤å®ç°å¾ˆå¯èƒ½è¾¾ä¸åˆ°éœ€æ±‚ï¼Œè¿˜ä¸å¦‚è‡ªå·±åŠ¨æ‰‹ã€‚

== å­˜å‚¨ ACL

ACL éœ€è¦è¢«æŒä¹…åŒ–èµ·æ¥ï¼Œå¦åˆ™ç³»ç»Ÿé‡å¯åå°±ä¸¢æ‰äº†æƒé™ä¿¡æ¯ã€‚

=== åŸºäº JDBC çš„æŒä¹…åŒ–

Spring Security ACL æä¾›äº†é»˜è®¤çš„ `AclService` å’Œ `MutableAclService` å®ç°ï¼š`JdbcAclService` å’Œ `JdbcMutableAclService`ã€‚

å› ä¸ºæ˜¯åŸºäº `JDBC` çš„å®ç°ï¼Œæ‰€ä»¥å°±å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼ˆç»å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦æ›´æ–° ACLï¼Œä½†ä½¿ç”¨ JDBC æ—¶æ€»æ˜¯ä¼šè®¿é—®æ•°æ®åº“ï¼Œå¾—åˆ°ä¸€æ¨¡ä¸€æ ·çš„ ACLï¼‰ã€‚
äºæ˜¯ ACL åˆè®¾è®¡äº†ä¸€ä¸ªç¼“å­˜æœºåˆ¶æ¥å‡å°‘å¯¹æ•°æ®åº“çš„è¯·æ±‚ã€‚ç¼“å­˜çš„æ¥å£æ˜¯ `AclCache`ï¼ŒSpring æä¾›äº†åŸºäº Eh-Cache å’Œ Spring Cache çš„ä¸¤ä¸ªå®ç°ã€‚

> `AclCache` æ¥å£è¢«å®‰æ’åœ¨äº† `org.springframework.security.acls.model` åŒ…ä¸­ã€‚
> ä¸ªäººè§‰å¾—è¿™ä¸æ˜¯ä¸€ä¸ªå¿…é¡»çš„å…ƒç´ ï¼Œç®—ä¸ä¸Šæ ¸å¿ƒæ¦‚å¿µï¼Œä¸åº”è¯¥å’Œå…¶ä»–æ ¸å¿ƒæ¦‚å¿µæ”¾åˆ°ä¸€èµ·ã€‚

==== åˆ›å»ºæ•°æ®åº“

`JdbcAclService` éœ€è¦åˆ›å»ºå››å¼ è¡¨ï¼Œåˆ›å»ºè¡¨çš„ SQL å·²ç»åœ¨ jar åŒ…é‡Œäº†ï¼ˆ*ä½†æ˜¯æœ‰å‘*ï¼‰ï¼Œæˆ‘ä»¬åªæ˜¯æ¥çœ‹çœ‹è¿™å‡ å¼ è¡¨åˆ†åˆ«ä¿å­˜äº†ä»€ä¹ˆå†…å®¹ã€‚

acl_sid::
- id: ä¸»é”®
- principal: ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¿™ä¸ª sid æ˜¯ä¸æ˜¯ `PrincipalSid`ï¼Œå¦‚æœå€¼ä¸º `false` åˆ™è¡¨ç¤º sid æ˜¯ `GrantedAuthoritySid`
+
____
è¿™ä¸ªè®¾è®¡ç®€ç›´æŠŠæ‰©å±•å µæ­»äº† ğŸ™„ï¸
____
- sid: `Sid` å®ä¾‹ä¸­ä¿å­˜çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯ `Principal.getName()` æˆ– `GrantedAuthority.getAuthority()` æˆ–è‡ªå·±å†™ä»£ç ç”Ÿæˆçš„å­—ç¬¦ä¸²

acl_class::
- id: ä¸»é”®
- class: Domain Object ç±»å‹çš„å…¨é™å®šå
+
`ObjectIdentity` çš„é»˜è®¤å®ç°ä½¿ç”¨ å…¨é™å®šå+id çš„æ–¹å¼ç¡®å®šä¸€ä¸ª Domain Object
- class_id_type: å¯é€‰å­—æ®µï¼Œä¿å­˜`ObjectIdentity` ä¸­ `identifier` çš„ç±»å‹ï¼Œé»˜è®¤æ˜¯ `Long`
+
*è¿™å°±æ˜¯å‘çš„æ‰€åœ¨*ã€‚Jar åŒ…ä¸­ç»™å‡ºçš„ SQL æœ‰ä¸åŒçš„æ•°æ®åº“çš„ç‰ˆæœ¬ï¼Œåªæœ‰ `PostgreSql` å’Œ `HSQL` çš„ç‰ˆæœ¬ä¸­æœ‰è¿™ä¸ªå­—æ®µã€‚
å¦‚æœä¸åˆ›å»ºè¿™ä¸ªå­—æ®µï¼Œé‚£ä¹ˆ `ObjectIdentity` å°±åªèƒ½æ”¯æŒ `Long` ç±»å‹çš„ idã€‚
`JdbcService` é»˜è®¤ä¹Ÿä¸ä¼šæŸ¥è¯¢è¿™ä¸ªå­—æ®µï¼Œéœ€è¦ç‰¹åˆ«é…ç½®ã€‚

acl_object_identity::
- id: ä¸»é”®
- object_id_class: å¤–é”®ä¾èµ– `acl_class.id`
- object_id_identity: `ObjectIdentity.getIdentifer()` çš„å€¼ï¼Œä¸ `object_id_class` ç»„æˆå”¯ä¸€é”®
- parent_object: å¤–é”®ä¾èµ– `acl_object_identity.id`ï¼Œåœ¨ `Acl` ç»§æ‰¿æ—¶ä½¿ç”¨
- owner_sid: å¤–é”®ä¾èµ– `acl_sid.id`ï¼Œæ˜¯ `Acl` å®ä¾‹çš„ ownerï¼Œæ‹¥æœ‰ä¿®æ”¹ `Acl` çš„æƒé™
- entries_inheriting: å¸ƒå°”å€¼ï¼Œè¡¨ç¤º child acl æ˜¯å¦è¦ç»§æ‰¿ parent acl çš„ ACE

è¿™å¼ è¡¨é‡Œä¿å­˜çš„éƒ½æ˜¯ `Acl` æŒæœ‰çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™å¼ è¡¨çš„ä¸€è¡Œè®°å½•å¯¹åº”äº†ä¸€ä¸ª `Acl` å®ä¾‹ã€‚

acl_entry::
- id: ä¸»é”®
- acl_object_identity: å¤–é”®ä¾èµ– `acl_object_identity.id`ï¼Œè¡¨ç¤ºå±äºå“ªä¸€ä¸ª `Acl`
- ace_order: è¡¨ç¤ºè¿™ä¸€æ¡ ACE åœ¨ `Acl` ä¸­çš„é¡ºåºï¼Œå’Œ `acl_object_identity` ç»„æˆå”¯ä¸€é”®
- sid: å¤–é”®ä¾èµ– `acl_sid.id`ï¼Œè¡¨ç¤ºè¿™æ¡ ACE çš„æƒé™å¯¹åº”å“ªä¸€ä¸ª `Sid`
- mask: è¡¨ç¤ºæƒé™çš„ 32 ä½äºŒè¿›åˆ¶æ•°å­—
- granting: å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¿™æ¡ ACE æ˜¯å¦ç”Ÿæ•ˆ
- audit_success
- audit_failure: è¿™ä¸¤æ¡æ˜¯ç”¨äºå®¡è®¡çš„ä¿¡æ¯ï¼Œå¯¹åº”äº† `AuditableAccessControlEntry` æ¥å£ï¼Œæœ¬æ–‡ä¸ä¼šæ¶‰åŠ

è¿™å¼ è¡¨ä¿å­˜çš„æ˜¯ ACE çš„ä¿¡æ¯ï¼Œä¸€è¡Œè®°å½•å¯¹åº”äº†ä¸€ä¸ª ACE å®ä¾‹ã€‚

==== é…ç½® JdbcAclService

åœ¨åŠ¨æ‰‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ `JdbcAclService` éƒ½æœ‰ä»€ä¹ˆä¾èµ–ï¼š

image::jdbc-acl-service-dependencies.png[]

å› ä¸º ACL æ²¡æœ‰ Spring Boot çš„ auto configureï¼Œæ‰€ä»¥é™¤äº† `DataSource`ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±æ¥é…ç½®è¿™äº›ä¾èµ–ã€‚

é™¤éé¡¹ç›®ä¸­ä¸éœ€è¦ä¿®æ”¹ ACLï¼Œå¦åˆ™éƒ½ä¼šé€‰æ‹©åˆ›å»ºä¸€ä¸ª `JdbcMutableAclService` è€Œä¸æ˜¯ `JdbcAclService`ã€‚

===== æ³¨å…¥ JdbcMutableAclService

[source,java]
----
@Bean
public MutableAclService mutableAclService() {
  JdbcMutableAclService jdbcMutableAclService = new JdbcMutableAclService(datasource, lookupStrategy(), aclCache());
  jdbcMutableAclService.setAclClassIdSupported(true); <1>
  jdbcMutableAclService.setClassIdentityQuery("SELECT @@IDENTITY"); <2>
  jdbcMutableAclService.setSidIdentityQuery("SELECT @@IDENTITY"); <3>
  return jdbcMutableAclService;
}
----
<1> å¦‚æœè¦æ”¯æŒ `acl_class.class_id_type` å­—æ®µï¼Œåˆ™éœ€è¦å°† `aclClassIdSupported` è®¾ç½®ä¸º `true`ã€‚è¿™æ · `JdbcAclService` åœ¨æŸ¥è¯¢æ—¶å’Œ `JdbcMutableAclService` æ›´æ–°æ—¶æ‰ä¼šè€ƒè™‘è¿™ä¸ªå­—æ®µçš„å€¼ã€‚
<2> `classIdentityQuery` ä¼šåœ¨åˆ›å»º `Acl` å¯¹è±¡æ—¶ç”¨åˆ°ï¼Œç”¨æ¥è·å–åˆšåˆšæ’å…¥çš„ `acl_class.id`ã€‚é»˜è®¤å€¼æ˜¯ `call identity()`ï¼Œè¿™æ˜¯ `H2` æ•°æ®åº“çš„æ–¹è¨€ï¼Œè¿™é‡Œçš„ä¾‹å­æ˜¯ `MySql` çš„æ–¹è¨€ã€‚
<3> ä¸ 2 ç›¸åŒï¼Œåªæ˜¯ç”¨æ¥è·å–åˆšåˆšæ’å…¥çš„ `acl_sid.id`

æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦é…ç½® `LookupStrategy` å’Œ `AclCache`ã€‚

===== æ³¨å…¥ LookupStrategy

`LookupStratege` åªæœ‰ä¸€ä¸ªå®ç°ï¼š`BasicLookupStrategy`

[source,java]
----
@Bean
public LookupStrategy lookupStrategy() {
  BasicLookupStrategy basicLookupStrategy = new BasicLookupStrategy(datasource, aclCache(), aclAuthorizationStrategy(), permissionGrantingStrategy());
  basicLookupStrategy.setAclClassIdSupported(true); <1>
  return basicLookupStrategy;
}
----
<1> `BasicLookupStrategy` ä¹Ÿä¼šè‡ªå·±ç»„è£… sqlï¼Œé€šç”¨éœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä»¥æ”¯æŒ `acl_class.class_id_type`ã€‚

æ¥ç€ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ `AclAuthorizationStrategy` å’Œ `PermissionGratingStrategy` è¿™ä¸¤ä¸ªç®€å•ä¸€ç‚¹çš„ä¾èµ–ã€‚

===== æ³¨å…¥ AclAuthorizationStrategy

[source,java]
----
@Bean
public AclAuthorizationStrategy aclAuthorizationStrategy() {
  return new AclAuthorizationStrategyImpl(new SimpleGrantedAuthority("owner"));
}
----

`AclAuthorizationStrategy` æ˜¯ç”¨æ¥åˆ¤æ–­å½“å‰çš„ `Autentication` æ˜¯å¦æœ‰æƒé™ä¿®æ”¹ `Acl` çš„æ¥å£ï¼Œå®ƒåªæœ‰ `AclAuthorizationStrategyImpl` è¿™ä¸€ä¸ªå®ç°ã€‚
è¿™ä¸ªæ¥å£è§„å®šäº†ä¸‰ç§æƒé™ï¼š

- change ownership ä¿®æ”¹ Acl çš„ owner
- change auditing ä¿®æ”¹ Acl çš„å®¡è®¡ä¿¡æ¯
- change general ä¿®æ”¹ ACE

å®ç°ä¸­æœ‰ä¸‰ä¸ª `GrantedAuthority` å±æ€§ï¼Œå¯¹åº”äº†ä¸Šé¢çš„ä¸‰ç§æƒé™ï¼Œè¡¨ç¤ºå¯¹ `Acl` è¿›è¡ŒæŸç§æ“ä½œæ—¶ï¼Œ`Authentication` éœ€è¦æ»¡è¶³å¯¹åº”çš„ `GrantedAuthority`ã€‚

å®ƒçš„æ„é€ æ–¹æ³•æ¥å—ä¸€ä¸ªæˆ–ä¸‰ä¸ª `GrantedAuthority`:

- å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆä¸‰ä¸ªæƒé™éƒ½æ˜¯è¿™ä¸ª `GrantedAuthority`
- å¦‚æœæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå°±ä¼šæŒ‰ä¸Šé¢çš„é¡ºåºèµ‹å€¼ç»™è¿™ä¸‰ä¸ªæƒé™

åœ¨åˆ¤æ–­æƒé™æ—¶ï¼Œå¦‚æœæ˜¯ `Acl` çš„ ownerï¼Œä¸”ä¸æ˜¯åœ¨ä¿®æ”¹å®¡è®¡ä¿¡æ¯æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥è·å¾—æƒé™ï¼›å¦åˆ™å°±éœ€è¦ `Authentication` å…·å¤‡å¯¹åº”çš„ `GrantedAuthority`ã€‚

===== æ³¨å…¥ PermissionGrantingStrategy

[source,java]
----
@Bean
public PermissionGrantingStrategy permissionGrantingStrategy() {
  return new DefaultPermissionGrantingStrategy(new ConsoleAuditLogger());
}
----

`PermissionGrantingStrategy` æŠ½è±¡äº† `isGranted` æ–¹æ³•ï¼Œè¢« `AclImpl` è°ƒç”¨ï¼Œæ˜¯çœŸæ­£æ‰§è¡Œæƒé™åˆ¤æ–­çš„åœ°æ–¹ã€‚
è¿™ä¸ªæ¥å£åªæœ‰è¿™ä¸€ä¸ªå®ç°ã€‚

===== æ³¨å…¥ AclCache

`AclCache` æœ‰ä¸¤ç§å®ç°ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ Spring æä¾›çš„è¿™ç§å®ç°

[source,java]
----
@Bean
public AclCache aclCache() {
  return new SpringCacheBasedAclCache(cache(), permissionGrantingStrategy(), aclAuthorizationStrategy());
}

@Bean
public Cache cache() {
  return new NoOpCache("any");
}
----

`Cache` æ˜¯ Spring æä¾›çš„æ¥å£ï¼Œæœ‰å¤šä¸ªå®ç°ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ï¼Œå°±é€‰æ‹©äº† `NoOpCache`ã€‚

åˆ°è¿™é‡Œï¼Œ`JdbcAclService` çš„é…ç½®å°±æš‚æ—¶å‘Šä¸€æ®µè½äº†ï¼Œè¿™äº›é…ç½®å·²ç»è¶³å¤Ÿæˆ‘ä»¬åœ¨åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ Domain Object ä¹‹åä¿®æ”¹ `Acl` å¯¹è±¡äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•æ›´æ–° `Acl`ã€‚

=== åˆ›å»º ACL

=== æ›´æ–° ACL

=== åˆ é™¤ ACL